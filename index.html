<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Parleto recruitment task</title>
		<style>
			body {
				font-family: system-ui, sans-serif;
			}
			table,
			table * {
				border-collapse: collapse;
				padding: 0;
				border: none;
			}

			#summaryTable {
				box-shadow: 0 0 0 2px #999;
			}

			.table-head__month,
			.table-head__category-day,
			.table-head__expenses,
			.table-element__month-year,
			.table-element__month-total td,
			.table-element__category td,
			.table-element__day-amounts > td {
				outline: 1px solid #999;
				border-collapse: collapse;
				padding: 5px;
			}

			#summaryTable {
				min-width: 300px;
				margin: 10px;
			}

			.table-head__month {
				width: 33%;
			}

			.table-head__category-day-expenses {
				width: 67%;
			}

			.table-head__category-day-expenses > table {
				width: 100%;
			}

			.table-head__category-day-expenses th {
				width: 50%;
			}

			.table-element__category-day-expenses > table {
				width: 100%;
			}

			.table-element__category-total {
				width: 50%;
			}

			.table-element__amount:after {
				content: ',';
				padding-right: 5px;
			}

			.table-element__amount:last-child:after {
				content: none;
			}

			#showFilters {
				margin: 10px;
			}

			#showFilters span {
				margin-right: 10px;
			}
		</style>
	</head>
	<body>
		<button id="openAddExpenseModal">Add expense</button>
		<dialog id="addExpenseModal">
			<form method="dialog" id="addExpenseForm">
				<label for="dateAddExpense">Date</label>
				<input type="date" id="dateAddExpense" />
				<label for="categoryAddExpense">Category</label>
				<select class="category" id="categoryAddExpense"></select>
				<label for="amountAddExpense">Amount</label>
				<input type="number" id="amountAddExpense" />
				<button id="addExpense" type="button">Add</button>
				<button class="close-modal" id="closeAddExpenseModal" type="button">x</button>
				<div class="success-message" id="addExpenseModalSuccess"></div>
				<div class="error-message" id="addExpenseModalError"></div>
			</form>
		</dialog>
		<button id="openRemoveExpenseModal">Remove expense</button>
		<dialog id="removeExpenseModal">
			<form method="dialog" id="removeExpenseForm">
				<label for="dateRemoveExpense">Date</label>
				<input type="date" id="dateRemoveExpense" />
				<label for="categoryRemoveExpense">Category</label>
				<select class="category" id="categoryRemoveExpense"></select>
				<label for="amountRemoveExpense">Amount</label>
				<input type="number" id="amountRemoveExpense" />
				<button id="removeExpense" type="button">Remove</button>
				<button class="close-modal" id="closeRemoveExpenseModal" type="button">x</button>
				<div class="success-message" id="removeExpenseModalSuccess"></div>
				<div class="error-message" id="removeExpenseModalError"></div>
			</form>
		</dialog>
		<button id="openFilterModal">Filter</button>
		<dialog id="filterModal">
			<form method="dialog" id="filterForm">
				<label for="dateFilter">Date</label>
				<input type="month" id="dateFilter" />
				<label for="categoryFilter">Category</label>
				<select class="category" id="categoryFilter" multiple></select>
				<label for="minAmount">Min Amount</label>
				<input type="number" id="minAmount" />
				<label for="maxAmount">Max Amount</label>
				<input type="number" id="maxAmount" />
				<button id="setFilter" type="button">Filter</button>
				<button class="close-modal" id="closeFilterModal" type="button">x</button>
			</form>
		</dialog>
		<button id="clearFilter" type="button">Clear filters</button>
		<div id="showFilters">
			Filters:
			<span id="showDateFilter"></span>
			<span id="showCategoryFilter"></span>
			<span id="showMinAmountFilter"></span>
			<span id="showMaxAmountFilter"></span>
		</div>
		<button id="openAddCategoryModal">Add category</button>
		<dialog id="addCategoryModal">
			<form method="dialog" id="addCategoryForm">
				<label for="addCategory">Category</label>
				<input type="text" id="addCategory" />
				<div id="addCategoryError"></div>
				<div id="addCategorySuccess"></div>
				<button id="addCategoryBtn" type="button">Add</button>
				<button class="close-modal" id="closeAddCategoryModal" type="button">x</button>
			</form>
		</dialog>
		<button id="openRemoveCategoryModal">Remove category</button>
		<dialog id="removeCategoryModal">
			<form method="dialog" id="removeCategoryForm">
				<label for="removeCategory">Category</label>
				<select class="category" id="removeCategory"></select>
				<button id="removeCategoryBtn" type="button">Remove</button>
				<div id="removeCategoryError"></div>
				<div id="removeCategorySuccess"></div>
				<button class="close-modal" id="closeRemoveCategoryModal" type="button">x</button>
			</form>
		</dialog>
		<table id="summaryTable">
			<thead>
				<tr class="table-head">
					<th class="table-head__month">Month</th>
					<th class="table-head__category-day-expenses">
						<table>
							<tr>
								<th class="table-head__category-day">Category/Day</th>
								<th class="table-head__expenses">Expenses</th>
							</tr>
						</table>
					</th>
				</tr>
			</thead>
			<tbody id="summaryTableBody"></tbody>
		</table>

		<script>
			categories = new Set(['food', 'fuel', 'other']);
			function renderCategories() {
				const categorySelects = document.querySelectorAll('select.category');
				const removeCategory = document.getElementById('removeCategory');
				const categoryFilter = document.getElementById('categoryFilter');

				// Create a document fragment to hold the new options
				const fragment = document.createDocumentFragment();

				// Add new options
				categories.forEach(category => {
					const option = document.createElement('option');
					option.value = category;
					option.text = category;
					fragment.appendChild(option);
				});

				// Populate select elements with categories
				categorySelects.forEach(select => {
					// Clear existing options
					select.innerHTML = '';
					select.appendChild(fragment.cloneNode(true));
				});

				// Remove 'other' option from 'removeCategory' select element
				for (let i = 0; i < removeCategory.options.length; i++) {
					if (removeCategory.options[i].value === 'other') {
						removeCategory.remove(i);
						break;
					}
				}

				// Add 'empty' option to 'filterCategory' select element
				let option = new Option('', '');
				option.selected = true;
				categoryFilter.add(option, 0);
			}

			expenses = [
				new Map([
					['date', '2024-03-02'],
					['category', 'food'],
					['amount', '9'],
				]),
				new Map([
					['date', '2024-03-02'],
					['category', 'fuel'],
					['amount', '99'],
				]),
				new Map([
					['date', '2024-01-29'],
					['category', 'fuel'],
					['amount', '93'],
				]),
				new Map([
					['date', '2024-01-29'],
					['category', 'food'],
					['amount', '14'],
				]),
				new Map([
					['date', '2024-01-29'],
					['category', 'fuel'],
					['amount', '99'],
				]),
			];

			function sortExpenses() {
				let sortedExpenses = expenses.slice();
				sortedExpenses.sort((a, b) => {
					return a.get('date') > b.get('date') ? 1 : -1;
				});
				return sortedExpenses;
			}

			function filterExpenses() {
				const sortedExpensesLocal = sortExpenses();
				let filteredExpensesLocal = [];
				let filtersLocal = new Map();

				const date = document.getElementById('dateFilter').value;
				filtersLocal.set('date', date);
				document.getElementById('showDateFilter').textContent = date ? `date (${date});` : '';
				const selectedCategories = Array.from(document.getElementById('categoryFilter').selectedOptions).map(
					option => option.value
				);
				filtersLocal.set('category', selectedCategories);
				document.getElementById('showCategoryFilter').textContent =
					selectedCategories[0] !== '' ? 'category (' + selectedCategories.join(', ') + ');' : '';
				const minAmount = document.getElementById('minAmount').value;
				filtersLocal.set('minAmount', minAmount);
				document.getElementById('showMinAmountFilter').textContent = minAmount ? `min amount (${minAmount});` : '';
				const maxAmount = document.getElementById('maxAmount').value;
				filtersLocal.set('maxAmount', maxAmount);
				document.getElementById('showMaxAmountFilter').textContent = maxAmount ? `max amount (${maxAmount});` : '';

				filteredExpensesLocal = sortedExpensesLocal.filter(expense => {
					const expenseDate = expense.get('date').slice(0, 7);
					const expenseCategory = expense.get('category');
					const expenseAmount = expense.get('amount');
					return (
						(!date || expenseDate === date) &&
						(selectedCategories[0] === '' || selectedCategories.includes(expenseCategory)) &&
						(!minAmount || Number(expenseAmount) >= Number(minAmount)) &&
						(!maxAmount || Number(expenseAmount) <= Number(maxAmount))
					);
				});

				return filteredExpensesLocal;
			}

			//get array of numbers representing days in a month
			function getDaysInMonth(monthYear) {
				const year = parseInt(monthYear.split('-')[0]);
				const month = parseInt(monthYear.split('-')[1]);
				return new Date(year, month, 0).getDate();
			}

			function calculateMonths(expensesArr) {
				monthsLocal = new Map();
				//create a new map with month as key and an array of expenses as value
				const monthExpenses = new Map();
				expensesArr.forEach(expense => {
					const month = expense.get('date').slice(0, 7);
					const day = Number(expense.get('date').slice(8));

					if (monthExpenses.has(month)) {
						//another expense for this month
						monthExpenses.get(month).push(expense);
					} else {
						//first expense for this month
						monthExpenses.set(month, [expense]);
						monthsLocal.set(month, new Map());
						monthsLocal.get(month).set('name', month);
						monthsLocal.get(month).set('days', getDaysInMonth(month));
					}
				});

				monthExpenses.forEach((monthExpensesArray, month) => {
					//add up all expenses for each month
					const total = monthExpensesArray.reduce((acc, expense) => {
						return acc + Number(expense.get('amount'));
					}, 0);
					monthsLocal.get(month).set('total', total);

					//add up all expenses for each category
					monthsLocal.get(month).set('categories', new Map());
					const categoryExpenses = new Map();
					monthExpensesArray.forEach(expense => {
						const category = expense.get('category');
						if (categoryExpenses.has(category)) {
							categoryExpenses.get(category).push(expense);
						} else {
							categoryExpenses.set(category, [expense]);
							monthsLocal.get(month).get('categories').set(category, new Map());
						}
					});
					categoryExpenses.forEach((categoryExpensesArray, category) => {
						const total = categoryExpensesArray.reduce((acc, expense) => {
							return acc + Number(expense.get('amount'));
						}, 0);
						monthsLocal.get(month).get('categories').get(category).set('total', total);
						monthsLocal.get(month).get('categories').get(category).set('name', category);
					});
				});

				return monthsLocal;
			}

			function getAmountParentElement(monthYear, day, category) {
				let elements = document.querySelectorAll('.table-element__month-year');
				let filteredElements = Array.from(elements).filter(el => el.innerText.trim() === monthYear);
				const monthElement = filteredElements[0].nextElementSibling;
				elements = monthElement.getElementsByClassName(category);
				filteredElements = Array.from(elements).filter(el => {
					let childElement = el.querySelector('.table-element__day');
					return childElement && Number(childElement.innerText.trim()) === day;
				});
				const dayAmountsElement = filteredElements[0];
				const result = dayAmountsElement.querySelector('.table-element__amount').parentNode;
				return result;
			}

			function renderExpenses() {
				const expensesArray = filterExpenses();
				const monthsLocal = calculateMonths(expensesArray);

				//remove all rows from the table except for head
				const tableBody = document.getElementById('summaryTableBody');
				const rows = tableBody.querySelectorAll('.table-element');
				rows.forEach(row => {
					row.remove();
				});

				//render new rows
				monthsLocal.forEach(month => {
					const element = document.createElement('tr');
					element.classList.add('table-element');

					//elements created once for each month
					const monthYear = document.createElement('td');
					monthYear.classList.add('table-element__month-year');
					monthYear.textContent = month.get('name');
					const categoryDayExpenses = document.createElement('td');
					categoryDayExpenses.classList.add('table-element__category-day-expenses');
					const categoryDayExpensesTable = document.createElement('table');
					const monthTotal = document.createElement('tr');
					monthTotal.classList.add('table-element__month-total');
					monthTotal.classList.add('table-element__month-total');
					const monthTotalTd = document.createElement('td');
					monthTotalTd.setAttribute('colspan', '2');
					monthTotalTd.textContent = `total: ${month.get('total')}`;
					monthTotal.appendChild(monthTotalTd);
					categoryDayExpensesTable.appendChild(monthTotal);

					//elements created for each category
					month.get('categories').forEach(category => {
						const categoryTr = document.createElement('tr');
						categoryTr.classList.add('table-element__category');
						const categoryName = document.createElement('td');
						categoryName.classList.add('table-element__category-name');
						categoryName.textContent = category.get('name');
						const categoryTotal = document.createElement('td');
						categoryTotal.classList.add('table-element__category-total');
						categoryTotal.textContent = `total: ${category.get('total')}`;
						categoryTr.appendChild(categoryName);
						categoryTr.appendChild(categoryTotal);
						categoryDayExpensesTable.appendChild(categoryTr);

						//elements created for each day
						for (let i = 1; i <= month.get('days'); i++) {
							const dayAmounts = document.createElement('tr');
							dayAmounts.classList.add('table-element__day-amounts', `${category.get('name')}`);
							const dayTd = document.createElement('td');
							dayTd.classList.add('table-element__day');
							dayTd.textContent = i;
							const amountsTd = document.createElement('td');
							amountsTd.classList.add('table-element__amounts');
							const amountsTable = document.createElement('table');
							const amountsTr = document.createElement('tr');
							const amountTd = document.createElement('td');
							amountTd.classList.add('table-element__amount', 'table-element__amount--empty');
							amountTd.textContent = '-';

							dayAmounts.appendChild(dayTd);
							amountsTr.appendChild(amountTd);
							amountsTable.appendChild(amountsTr);
							amountsTd.appendChild(amountsTable);
							dayAmounts.appendChild(amountsTd);
							categoryDayExpensesTable.appendChild(dayAmounts);
						}
					});

					categoryDayExpenses.appendChild(categoryDayExpensesTable);
					element.appendChild(monthYear);
					element.appendChild(categoryDayExpenses);
					tableBody.appendChild(element);
				});

				//elements created for each expense
				expensesArray.forEach(expense => {
					const expenseCategory = expense.get('category');
					const expenseDate = expense.get('date');
					const expenseMonthYear = expenseDate.slice(0, 7);
					const expenseDay = Number(expenseDate.slice(8));
					const expenseAmount = expense.get('amount');

					const amountTd = document.createElement('td');
					amountTd.classList.add('table-element__amount');
					amountTd.textContent = expenseAmount;

					const parentElement = getAmountParentElement(expenseMonthYear, expenseDay, expenseCategory);
					parentElement.appendChild(amountTd);
					if (parentElement.querySelector('.table-element__amount--empty')) {
						//if there is an empty cell, remove it
						parentElement.querySelector('.table-element__amount--empty').remove();
					}
				});
			}

			function validateDate(date) {
				const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
				return dateRegex.test(date);
			}

			function validateCategory(category) {
				return categories.has(category);
			}

			function validateAmount(amount) {
				const amountRegex = /^\d+(\.\d{1,2})?$/;
				return amountRegex.test(amount);
			}

			function validateString(str) {
				const regex = /^[a-zA-Z0-9\s/()']+$/;
				return regex.test(str);
			}

			function areAllTruthy(...args) {
				for (let arg of args) {
					if (!arg) {
						return false;
					}
				}
				return true;
			}

			function addExpense(date, category, amount) {
				const newExpense = new Map([
					['date', date],
					['category', category],
					['amount', amount],
				]);
				expenses.push(newExpense);
				//push expenses to storage
				localStorage.setItem('expenses', JSON.stringify(expenses.map(map => Object.fromEntries(map))));
				renderExpenses();
			}

			function removeExpense() {
				const date = document.getElementById('dateRemoveExpense').value;
				const category = document.getElementById('categoryRemoveExpense').value;
				const amount = document.getElementById('amountRemoveExpense').value;
				let result = expenses.find(
					map => map.get('date') === date && map.get('category') === category && map.get('amount') === amount
				);

				if (result) {
					expenses = expenses.filter(expense => expense !== result);
					//push expenses to storage
					localStorage.setItem('expenses', JSON.stringify(expenses.map(map => Object.fromEntries(map))));
					renderExpenses();
					return true;
				} else {
					return false;
				}
			}

			function loadDataFromStorage() {
				//load categories from storage
				if (localStorage.getItem('categories') === null) {
					// myData does not exist in localStorage
				} else {
					// myData exists in localStorage
					let retrievedCategoriesSet = new Set(JSON.parse(localStorage.getItem('categories')));
					categories = retrievedCategoriesSet;
				}
				//load expenses from storage
				if (localStorage.getItem('expenses') === null) {
					// expenses does not exist in localStorage
				} else {
					// expenses exists in localStorage
					let retrievedExpensesArray = JSON.parse(localStorage.getItem('expenses')).map(
						obj => new Map(Object.entries(obj))
					);
					expenses = retrievedExpensesArray;
				}
			}

			(function init() {
				//load categories and expenses from storage
				loadDataFromStorage();
				renderCategories();
				renderExpenses();
			})();

			(function addExpenseModal() {
				const expenseModal = document.getElementById('addExpenseModal');
				const openExpenseModal = document.getElementById('openAddExpenseModal');
				const closeExpenseModal = document.getElementById('closeAddExpenseModal');
				const addExpenseBtn = document.getElementById('addExpense');
				const addExpenseForm = document.getElementById('addExpenseForm');
				const addExpenseModalSuccess = document.getElementById('addExpenseModalSuccess');
				const addExpenseModalError = document.getElementById('addExpenseModalError');

				openExpenseModal.addEventListener('click', function () {
					expenseModal.showModal();
				});

				closeExpenseModal.addEventListener('click', function () {
					expenseModal.close();
				});

				addExpenseBtn.addEventListener('click', function () {
					const date = document.getElementById('dateAddExpense').value;
					const category = document.getElementById('categoryAddExpense').value;
					const amount = document.getElementById('amountAddExpense').value;
					if (!areAllTruthy(date, category, amount)) {
						addExpenseModalError.textContent = 'All fields are required';
						setTimeout(function () {
							addExpenseModalError.textContent = '';
						}, 4000);
					} else if (!validateDate(date)) {
						addExpenseModalError.textContent = 'Invalid date';
						setTimeout(function () {
							date = '';
							addExpenseModalError.textContent = '';
						}, 4000);
					} else if (!validateCategory) {
						addExpenseModalError.textContent = 'Invalid category';
						setTimeout(function () {
							category = '';
							addExpenseModalError.textContent = '';
						}, 4000);
					} else if (!validateAmount(amount)) {
						addExpenseModalError.textContent = 'Invalid amount';
						setTimeout(function () {
							amount = '';
							addExpenseModalError.textContent = '';
						}, 4000);
					} else {
						addExpense(date, category, amount);
						addExpenseModalSuccess.textContent = 'Expense added successfully';
						setTimeout(function () {
							addExpenseModalSuccess.textContent = '';
							expenseModal.close();
							addExpenseForm.reset();
						}, 2000);
					}
				});
			})();

			(function removeExpenseModal() {
				const expenseModal = document.getElementById('removeExpenseModal');
				const openExpenseModal = document.getElementById('openRemoveExpenseModal');
				const closeExpenseModal = document.getElementById('closeRemoveExpenseModal');
				const removeExpenseBtn = document.getElementById('removeExpense');

				openExpenseModal.addEventListener('click', function () {
					expenseModal.showModal();
				});

				closeExpenseModal.addEventListener('click', function () {
					expenseModal.close();
				});

				removeExpenseBtn.addEventListener('click', function () {
					const result = removeExpense();
					if (result) {
						document.getElementById('removeExpenseModalSuccess').textContent = 'Expense removed successfully';
						setTimeout(function () {
							expenseModal.close();
						}, 2000);
					} else {
						document.getElementById('removeExpenseModalError').textContent = 'No such expense found';
						setTimeout(function () {
							document.getElementById('removeExpenseForm').reset();
							document.getElementById('removeExpenseModalError').textContent = '';
						}, 4000);
					}
				});
			})();

			(function filterModal() {
				const filterModal = document.getElementById('filterModal');
				const openFilterModal = document.getElementById('openFilterModal');
				const closeFilterModal = document.getElementById('closeFilterModal');
				const setFilter = document.getElementById('setFilter');

				openFilterModal.addEventListener('click', function () {
					filterModal.showModal();
				});

				closeFilterModal.addEventListener('click', function () {
					filterModal.close();
				});

				setFilter.addEventListener('click', function () {
					renderExpenses();
					filterModal.close();
				});
			})();

			(function clearFilter() {
				const clearFilter = document.getElementById('clearFilter');
				clearFilter.addEventListener('click', function () {
					document.getElementById('filterForm').reset();
					renderExpenses();
				});
			})();

			(function addCategoryModal() {
				const addCategoryModal = document.getElementById('addCategoryModal');
				const openAddCategoryModal = document.getElementById('openAddCategoryModal');
				const closeAddCategoryModal = document.getElementById('closeAddCategoryModal');
				const addCategoryBtn = document.getElementById('addCategoryBtn');
				const addCategory = document.getElementById('addCategory');
				const addCategoryForm = document.getElementById('addCategoryForm');

				openAddCategoryModal.addEventListener('click', function () {
					addCategoryModal.showModal();
				});

				closeAddCategoryModal.addEventListener('click', function () {
					addCategoryForm.reset();
					addCategoryModal.close();
				});

				addCategoryBtn.addEventListener('click', function () {
					const newCategory = addCategory.value;
					const addCategoryError = document.getElementById('addCategoryError');
					const addCategorySuccess = document.getElementById('addCategorySuccess');
					if (categories.has(newCategory)) {
						addCategoryError.textContent = 'This category already exists.';
						setTimeout(function () {
							addCategoryForm.reset();
							addCategoryError.textContent = '';
						}, 4000);
					} else if (validateString(newCategory)) {
						categories.add(newCategory);
						//push categories to storage
						localStorage.setItem('categories', JSON.stringify(Array.from(categories)));
						renderCategories();
						addCategorySuccess.textContent = 'Category added successfully';
						setTimeout(function () {
							addCategorySuccess.textContent = '';
							addCategoryForm.reset();
							addCategoryModal.close();
						}, 2000);
						addCategoryError.textContent = ''; // clear the error message
					} else if (newCategory === '') {
						addCategoryError.textContent = 'Category name is required';
						setTimeout(function () {
							addCategoryError.textContent = '';
						}, 4000);
					} else {
						addCategoryError.textContent =
							"Invalid category name (only letters, numbers, spaces, /, (, ) and ' are allowed)";
						setTimeout(function () {
							addCategoryForm.reset();
							addCategoryError.textContent = '';
						}, 4000);
					}
				});
			})();

			(function removeCategoryModal() {
				const removeCategoryModal = document.getElementById('removeCategoryModal');
				const openRemoveCategoryModal = document.getElementById('openRemoveCategoryModal');
				const closeRemoveCategoryModal = document.getElementById('closeRemoveCategoryModal');
				const removeCategoryBtn = document.getElementById('removeCategoryBtn');
				const removeCategoryForm = document.getElementById('removeCategoryForm');
				const removeCategorySuccess = document.getElementById('removeCategorySuccess');
				const removeCategoryError = document.getElementById('removeCategoryError');

				openRemoveCategoryModal.addEventListener('click', function () {
					removeCategoryModal.showModal();
				});

				closeRemoveCategoryModal.addEventListener('click', function () {
					removeCategoryForm.reset();
					removeCategoryModal.close();
				});

				removeCategoryBtn.addEventListener('click', function () {
					const removeCategory = document.getElementById('removeCategory');
					const selectedCategory = removeCategory.value;
					if (selectedCategory === 'other') {
						removeCategoryError.textContent = 'Category  "other" cannot be removed';
						setTimeout(function () {
							removeCategoryError.textContent = '';
							removeCategoryForm.reset();
							removeCategoryModal.close();
						}, 2000);
					} else {
						categories.delete(selectedCategory);
						expenses.forEach(expense => {
							if (expense.get('category') === selectedCategory) {
								expense.set('category', 'other');
							}
						});
						//push categories to storage
						localStorage.setItem('categories', JSON.stringify(Array.from(categories)));
						renderCategories();
						renderExpenses();
						removeCategorySuccess.textContent = 'Category removed successfully';
						setTimeout(function () {
							removeCategorySuccess.textContent = '';
							removeCategoryModal.close();
							removeCategoryForm.reset();
						}, 2000);
					}
				});
			})();
		</script>
	</body>
</html>
